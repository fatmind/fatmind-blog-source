---
title: 任务调度
date: 2016-09-20 14:47:37
tags: 分布式，任务调度
---


作为一个任务调度系统，其核心要考虑哪些点？是中心式，还是分布式？任务如何分配？失败节点如何转移？下面以 [淘宝tbschedule](http://code.taobao.org/p/tbschedule/wiki/index/)、[阿里云scheduleX](https://help.aliyun.com/document_detail/43136.html?spm=5176.doc43128.6.214.0dClN0) 为例来分析。

<!-- more -->

##### 一、从基本要素谈起

任何一个调度系统，其都必须回答：资源管理、任务分配、谁来驱动，这几个基本问题。

1.资源管理
随着任务增多，如何提升机器资源效率和保证高优先级任务。
a、机器效率提升，必须在机器上再有抽象一层，如：ts线程组。从而依据机器配置情况，定义其可提供资源数量，如：4g4核与16g16核。
b、业务中，（订单自动取消任务）比（统计用户访问量任务）的优先级高，如何保证低优先级不会影响高优先级，资源隔离则是最直接和有效的办法。如：ts策略定义中，需明确定义执行任务的机器。

2.任务分配
首先要回答（谁）来分配？当任务明确后，由中心来分配，还是无中心选举leader来分配，sx是前者，ts是后者。
a、中心分配：使用者的理解和问题排查成本会低；理论上存在单点风险，其分配节点自身的稳定性要求高；一般采用随机分配策略。
b、无中心：需要引入第三方协调者角色，常用zk，任务定义明确后写入zk，由集群选举leader后按照一定策略分配，各节点定时或走watcher去获取最新分配信息，自我调整自己；使用者成本会变高。

3.谁来驱动
此答案依赖第2点。
a、中心分配：由中心来触发，如http请求。
b、无中心：执行节点自身需要有定时执行的驱动，如quartz或timer等。

##### 二、进阶

从demo进化到可用系统，失败任务自动处理、告警、可用性等，则也必须考虑。

1.失败任务自动处理
a、中心分配：短时任务会同步等其响应，若失败从节点中再选一个分配即可；长时任务则需回调告知结果，失败同理，同时会定时检查是否超时。
b、无中心：当选举出leader后，leader就是中心节点。当任务失败或超时，都需要leader主动去关注。

2.告警
a、中心分配：每次调度就是一条有状态的数据，很容易实现告警逻辑，也方便后续排查分析。
b、无中心：一次性任务，根据任务状态则可区分；定时执行的任务，则需要额外来记录信息，做告警和分析。

3.可用性
a、中心分配：当随着任务增多，调度自身也需要分工，比如：A机器处理1-10，B机器处理10-20。若A机器挂掉，会自动把任务迁移到C机器处理。
b、无中心：无单点问题，等同zk稳定性。


>参考资料
>1.http://defworld.com/2016/09/14/tbschedule-source-code-analysis/
>2.https://help.aliyun.com/document_detail/43136.html?spm=5176.doc44194.6.214.F4bSks


