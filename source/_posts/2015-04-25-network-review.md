title: "常用网络知识复习"
date: 2015-04-25 10:16:14
tags:
---

题记：今天和周围同事讨论，load balance 如何处理数据转发。再复习下相关网络知识，相关知识点不断补充。

**1.LVS三种策略解释**

http://www.linuxvirtualserver.org/zh/lvs3.html
在阅读之后，自己有一些问题：
- NET方式，需要维护client->vip->realserver关系吗？
*调度器在连接Hash表中记录这个连接，当这个连接的下一个报文到达时，从连接Hash表中可以得到原选定服务器的地址和端口，进行同样的改写操作，并将报文传给原选定的服务器。*
需要。维护的目的，是保证下次数据包到来时，会转发到同一服务器。
- NET方式，realserver返回数据时，设置目标IP是：202.100.1.2:3456。==为什么vip会处理，进行源地址的转换？==
先提下为啥要转换，因为Tcp每个连接都是唯一确定的四元组（源IP+源port+目的Ip+目的port），若用realserver作为返回数据的源IP，肯定会出现错误。
- 什么是IP隧道技术？
https://sites.google.com/site/emmoblin/linux-network-1/linux-zhongip-sui-dao
IP协议是属于网络层（解决在一个单一网络上传输数据包的问题）。
最初的提出很简单，为了在TCP/IP网络中传输其他协议的数据包，如：我设计y协议，但在已有网络标准上都不支持，发出前先包一层ip协议，接受后先解开外面ip协议，再处理y协议，当然两端机器都必须做相关配置。
- VS/TUN技术避免‘返回数据时，再走一次vip，会成为瓶颈’。==vip与realserver之间的连接，何时断开呢？==

**2.TCP的time_wait复习**

http://www.iteblog.com/archives/169
http://blog.csdn.net/dog250/article/details/13760985

1. 首先要明确几个东西：
-Tcp是全双工通信
-Tcp是解决诸如端到端可靠性（数据是否已经到达目的地？）和保证数据按照正确的顺序到达这样的问题

2. 为什么需要timewait？
- Tcp连接关闭过程：
过程一.主动关闭方发送FIN，被动关闭方收到后发送该FIN的ACK；
过程二.被动关闭方发送FIN，主动关闭方收到后发送该FIN的ACK；
过程三.被动关闭方收到ACK。
假设被动方没收到最后的ack，且Tcp协议规范不需要对ACK进行ACK，此时连接已被释放，新的连接建立。可能被动方重传的fin，迷失在网络中一段时间后，又到达主动方，根据Tcp规范会返回rst错误，导致新建立的连接被断开。
- 为什么是2MSL？
MSL即Maximum Segment Lifetime，也就是报文最大生存时间，引用TCPIP详解中的话：它(MSL)是任何报文段被丢弃前在网络内的最长时间。
2倍=等fin消失+等ack返回到对方。
- 有什么副作用吗？
当某个连接的一端处于TIME_WAIT状态时，该连接将不能再被使用，若站在服务端，意味着端口被占用，无法处理新的请求。
解决这个问题的一个方法就是设置socket的SO_REUSEADDR选项。通知内核，如果端口忙，但TCP状态位于 TIME_WAIT，可以重用端口。如果端口忙，而TCP状态位于其他状态，重用端口时依旧得到一个错误信息，指明"地址已经使用中"。

**3.Tcp的rst复习**

http://blog.csdn.net/russell_tao/article/details/7228923

- RST表示复位，用来异常的关闭连接。
例如，A向B发起连接，但B之上并未监听相应的端口，这时B操作系统上的TCP处理程序会发RST包。又比如，AB正常建立连接了，正在通讯时，A向B发送了FIN包要求关连接，B发送ACK后，网断了，A通过若干原因放弃了这个连接（例如进程重启）。网通了后，B又开始发数据包，A收到后表示压力很大，不知道这野连接哪来的，就发了个RST包强制把连接关了，B收到后会出现connect reset by peer错误。
- 发送RST包关闭连接时，不必等缓冲区的包都发出去（不像上面的FIN包），直接就丢弃缓存区的包发送RST包。而接收端收到RST包后，也不必发送ACK包来确认。

**4.网络arp协议**

http://baike.baidu.com/subview/32698/16532303.htm?fromtitle=ARP%E5%8D%8F%E8%AE%AE&fromid=1742212&type=syn#2_1

其工作在网络层，负责根据ip查找物理地址（mac）。其核心是依赖arp缓存，按照一定策略保存ip到mac映射关系。
当地址解析协议被询问一个已知IP地址节点的MAC地址时，先在ARP缓存中查看，若存在，就直接返回与之对应的MAC地址，若不存在，才发送ARP请求向局域网广播，各台机器收到请求后，查看是否询问自己ip，若否则丢弃数据，若是则响应，且存储当前发来的ip与mac映射关系。
ARP请求为广播形式发送的，网络上的主机可以自主发送ARP应答消息，并且当其他主机收到应答报文时不会检测该报文的真实性就将其记录在本地的MAC地址转换表，这样攻击者就可以向目标主机发送伪ARP应答报文，从而篡改本地的MAC地址表。




