title: database_scale_data_migration
tags:
---

*先打个草稿思路*

随着数据的不断膨胀，‘扩容’这个词，大家也慢慢耳熟能详。梳理下大体思路，不涉及具体细节（如：oracle到mysql必须注意字段类型问题）

1. 无非两种
-垂直拆分：原本用户表、宝贝表在同一个库中，随着数据量膨胀，以服务化打通系统间的交互
-水平扩展：某单元业务场景下的数据，如宝贝，单库/单表也无法支持，需要水平扩容

2. 扩容必须满足的点：
-尽量对业务透明
-数据一致性
-万一有问题，如何回滚

3. 原理
数据迁移必然有追全量、增量过程，全量大家都一样，差异在增量是否需要停机/写，当进入增量阶段，本质上与数据库的master/slave没什么区别，在数据的一致性上总有一个时间差。
如果影响小（如运营后台）/强一致性要求的应用，在时间差缩小到可接受范围时，停写快速迁移，是最简单的方式。
若要求读写都无影响，核心是如何处理‘两边都更新的数据’如何处理？则必须有应用介入，不能单纯走一些迁移工具，如愚公。
http://www.atatech.org/article/detail/3653/0

4. 垂直拆分

- ~~对业务透明~~
不是单纯数据迁移，也涉及原来业务逻辑迁移，最好是能从业务逻辑层面去验证。如直通车迁移simba2，先双写，每日实时对比和全量对比，去校验是否一致。
再切部分用户走新路径，以灰度发布形式慢慢铺开。

- 数据一致性
对比，去发现是否逻辑迁移也存在问题。

- 如何回滚
反向同步。此时也涉及到回写的数据，与之前的数据，更新/丢弃的判断，也需要应用介入。

5. 水平扩展
相比垂直要简单一些，不涉及逻辑的迁移。主要是数据层面的变动。

6. 思考下：如果你要做这样的一个东西去支持数据迁移，你会考虑什么？
http://xue.alibaba-inc.com/trs/detail.htm?trainId=17cdb2f1-e02e-4797-8ea2-4990066d47a7


推荐阅读阿里在这方面的沉淀：
http://gitlab.alibaba-inc.com/junyu/dayu/wikis/home
http://xue.alibaba-inc.com/trs/mediaDetail.htm?mediaUid=1e11a6fc-2490-45ac-a6a1-5d445d2f6f90